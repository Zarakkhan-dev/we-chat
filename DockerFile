# ---------- Frontend (Bun build) ----------
FROM oven/bun:latest AS frontend

WORKDIR /app/web

COPY web/package.json web/bun.lock* ./
RUN bun install --frozen-lockfile

COPY web/ ./

ARG VITE_CLERK_PUBLISHABLE_KEY
ENV VITE_CLERK_PUBLISHABLE_KEY=$VITE_CLERK_PUBLISHABLE_KEY

ARG VITE_API_URL
ENV VITE_API_URL=$VITE_API_URL

RUN bun run build


# ---------- Backend (Node build) ----------
FROM node:20-alpine AS backend-build

WORKDIR /app/backend

COPY backend/package.json backend/package-lock.json* ./
RUN npm install

COPY backend/ ./


# ---------- Final Runtime Image ----------
FROM node:20-alpine

WORKDIR /app/backend

COPY --from=backend-build /app/backend/package.json ./
COPY --from=backend-build /app/backend/node_modules ./node_modules

# frontend served by backend
COPY --from=frontend /app/web/dist ./public

EXPOSE 5000
ENV PORT=5000
ENV NODE_ENV=production

CMD ["npm", "run", "start"]
